<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>배팅 페이지</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <style>
        .date-display {
            font-size: 0.42em;  /* 0.84em에서 50% 감소 */
            color: #666;
            margin: 10px 0;
            text-align: center;
        }
        
        .banner-container {
            height: 100px;
            overflow: hidden;
            position: relative;
            margin: 20px 0;
            background-color: #1a1a1a;
            border-radius: 8px;
        }
        
        .banner-slider {
            display: flex;
            width: 500%;
            animation: slide 25s infinite;
        }
        
        .banner-slide {
            width: 20%;
            flex-shrink: 0;
        }
        
        .banner-image {
            width: 100%;
            height: 100px;
            object-fit: cover;
        }
        
        @keyframes slide {
            0% { transform: translateX(0); }
            20% { transform: translateX(-20%); }
            40% { transform: translateX(-40%); }
            60% { transform: translateX(-60%); }
            80% { transform: translateX(-80%); }
            100% { transform: translateX(0); }
        }

        /* 빵빠레 효과 스타일 */
        .confetti-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
        }

        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: #f00;
            opacity: 0;
            animation: confetti-fall 3s ease-in-out forwards;
            clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%);
        }

        @keyframes confetti-fall {
            0% {
                transform: translateY(-100px) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }

        /* 은원도 효과 스타일 */
        .star {
            position: absolute;
            width: 20px;
            height: 20px;
            background: radial-gradient(circle at center, #fff 0%, #fff 40%, transparent 40%);
    </style>
</head>
<body class="bg-black text-white">

    <!-- 상단 네비게이션 -->
    <header class="flex justify-between items-center px-6 py-4 border-b border-gray-700">
        <div class="flex items-center space-x-3">
            <a href="https://ppadun9.com/" class="cursor-pointer">
                <img src="/img/logo.png" width="40" height="8" alt="PPADUN 로고">
            </a>
            <span id="userNameDisplay" class="text-xs font-bold text-blue-200"></span>
        </div>
        <div class="flex space-x-6">
            <div id="loginButton" class="text-center cursor-pointer" onclick="location.href='/login.html'" style="display: block;">
                <i class="fas fa-sign-in-alt text-2xl"></i>
                <p class="text-sm mt-1">로그인</p>
            </div>
            <div id="logoutButton" class="text-center cursor-pointer" onclick="logout()" style="display: none;">
                <i class="fas fa-sign-out-alt text-2xl"></i>
                <p class="text-[0.4rem] mt-1">로그아웃</p>
            </div>
            <div class="text-center cursor-pointer" onclick="location.href='settings.html'">
                <i class="fas fa-cog text-2xl"></i>
                <p class="text-[0.4rem] mt-1">설정</p>
            </div>
        </div>
    </header>

    <!-- 메인 컨테이너 -->
    <main class="p-4">
        <div class="bg-gray-800 max-w-lg mx-auto p-6 rounded-lg">
            <p class="text-right text-gray-300 mb-4" id="currentDate"></p>

            <!-- 배팅 폼 -->
            <div class="space-y-4">
                <div class="flex items-center space-x-3">
                    <img src="/img/menu1.png" width="50" height="50" alt="경기 이미지" class="rounded">
                    <div class="flex-1">
                        <p class="text-sm">경기선택</p>
                        <select id="gameSelect" class="w-full p-2 rounded bg-gray-600 text-white" 
                                title="경기를 선택하세요">
                            <option value="game1">두산 vs LG</option>
                            <option value="game2">SSG vs KT</option>
                            <option value="game3">키움 vs NC</option>
                            <option value="game4">삼성 vs KIA</option>
                            <option value="game5">롯데 vs 한화</option>
                        </select>
                    </div>
                </div>

                <div class="flex items-center space-x-3">
                    <img src="/img/menu2.png" width="50" height="50" alt="게임 이미지" class="rounded">
                    <div class="flex-1">
                        <p class="text-sm">게임선택</p>
                        <div class="flex gap-2 mt-2">
                            <button class="game-type-button bg-rose-200 text-gray-800 py-1 px-2 rounded flex-1 hover:bg-rose-300 text-xs" onclick="updateGameType('batter', this)">타자</button>
                            <button class="game-type-button bg-gray-200 text-gray-400 py-1 px-2 rounded flex-1 text-xs cursor-not-allowed" disabled>수비</button>
                            <button class="game-type-button bg-gray-200 text-gray-400 py-1 px-2 rounded flex-1 text-xs cursor-not-allowed" disabled>투수</button>
                        </div>
                        <p id="selectedGameType" class="text-sm text-yellow-400 mt-2 font-bold"></p>
                        <select id="gameTypeSelect" class="hidden" title="게임 유형을 선택하세요">
                            <option value="batter">타자</option>
                            <option value="defense" disabled>수비</option>
                            <option value="pitcher" disabled>투수</option>
                        </select>
                    </div>
                </div>

                <div class="flex items-center space-x-3">
                    <img src="/img/menu3.png" width="50" height="50" alt="배팅 이미지" class="rounded">
                    <div class="flex-1">
                        <p class="text-sm">배팅선택</p>
                        <div class="flex gap-1 mt-1">
                            <button class="result-button bg-blue-500 text-white py-1 px-2 rounded flex-1 text-xs" onclick="updateBetting('first', this)">1루</button>
                            <button class="result-button bg-green-500 text-white py-1 px-2 rounded flex-1 text-xs" onclick="updateBetting('second', this)">2루</button>
                            <button class="result-button bg-yellow-500 text-white py-1 px-2 rounded flex-1 text-xs" onclick="updateBetting('third', this)">3루</button>
                            <button class="result-button bg-red-500 text-white py-1 px-2 rounded flex-1 text-xs" onclick="updateBetting('homerun', this)">홈런</button>
                            <button class="result-button bg-gray-500 text-white py-1 px-2 rounded flex-1 text-xs" onclick="updateBetting('out', this)">아웃</button>
                        </div>
                        <p id="selectedBetting" class="text-sm text-yellow-400 mt-1 font-bold"></p>
                        <select id="bettingSelect" class="hidden" title="배팅 유형을 선택하세요">
                            <option value="first">1루</option>
                            <option value="second">2루</option>
                            <option value="third">3루</option>
                            <option value="homerun">홈런</option>
                            <option value="out">아웃</option>
                        </select>
                    </div>
                </div>

                <div class="flex items-center space-x-3">
                    <img src="/img/menu4.png" width="50" height="50" alt="배팅금액 이미지" class="rounded">
                    <div class="flex-1">
                        <p class="text-sm">배팅포인트</p>
                        <div class="flex gap-1 mt-1">
                            <button class="point-button bg-pink-200 text-gray-800 py-1 px-2 rounded flex-1 hover:bg-pink-300 text-xs" onclick="updatePoints(100, this)">100</button>
                            <button class="point-button bg-blue-200 text-gray-800 py-1 px-2 rounded flex-1 hover:bg-blue-300 text-xs" onclick="updatePoints(200, this)">200</button>
                            <button class="point-button bg-green-200 text-gray-800 py-1 px-2 rounded flex-1 hover:bg-green-300 text-xs" onclick="updatePoints(300, this)">300</button>
                            <button class="point-button bg-yellow-200 text-gray-800 py-1 px-2 rounded flex-1 hover:bg-yellow-300 text-xs" onclick="updatePoints(400, this)">400</button>
                            <button class="point-button bg-purple-200 text-gray-800 py-1 px-2 rounded flex-1 hover:bg-purple-300 text-xs" onclick="updatePoints(500, this)">500</button>
                        </div>
                        <p id="selectedPoints" class="text-sm text-yellow-400 mt-1 font-bold"></p>
                        <select id="pointSelect" class="hidden" title="배팅 포인트를 선택하세요">
                            <option value="100">100 포인트</option>
                            <option value="200">200 포인트</option>
                            <option value="300">300 포인트</option>
                            <option value="400">400 포인트</option>
                            <option value="500">500 포인트</option>
                        </select>
                    </div>
                </div>

                <p class="mt-4 text-sm">보유 포인트 : <span id="userPoints" class="font-bold">0포인트</span> 
                    <span id="afterBettingPoints" class="text-yellow-400 ml-2" style="display: none;">
                        → <span class="font-bold">0포인트</span>
                    </span>
                </p>
                <p class="text-sm">예상 배당 포인트 : <span id="expectedPoints" class="font-bold">0포인트</span></p>

                <!-- 배팅 버튼 -->
                <button id="bettingButton" class="w-full bg-blue-500 text-white py-3 rounded-lg font-bold mt-4">
                    배팅하기
                </button>

                <button id="bettingResultButton" class="flex items-center justify-center space-x-2 w-full py-3 mt-2 bg-blue-500 text-white font-bold rounded hidden">
                    <i class="fas fa-chart-line"></i>
                    <span>배팅결과</span>
                </button>

                <!-- 슬라이드 배너 -->
                <div class="banner-container">
                    <div class="banner-slider">
                        <div class="banner-slide">
                            <img src="https://img.freepik.com/free-vector/gradient-casino-banner_23-2148886820.jpg" alt="배팅 이벤트 1" class="banner-image">
                        </div>
                        <div class="banner-slide">
                            <img src="https://img.freepik.com/free-vector/gradient-points-collection-banner_23-2149401895.jpg" alt="포인트 충전" class="banner-image">
                        </div>
                        <div class="banner-slide">
                            <img src="https://img.freepik.com/free-vector/special-offer-sale-banner_23-2149401895.jpg" alt="특별 할인" class="banner-image">
                        </div>
                        <div class="banner-slide">
                            <img src="https://img.freepik.com/free-vector/gradient-casino-banner_23-2148886821.jpg" alt="배팅 이벤트 2" class="banner-image">
                        </div>
                        <div class="banner-slide">
                            <img src="https://img.freepik.com/free-vector/gradient-casino-banner_23-2148886822.jpg" alt="배팅 이벤트 3" class="banner-image">
                        </div>
                    </div>
                </div>

                <!-- 패배 결과 모달 -->
                <div id="loseModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
                    <div class="bg-gray-800 p-6 rounded-lg max-w-sm w-full mx-4">
                        <div class="text-center mb-6">
                            <i class="fas fa-times-circle text-red-500 text-5xl mb-4"></i>
                            <p class="font-bold text-xl mb-2">패배</p>
                            <p class="text-sm text-gray-300">아쉽게도 패배하였습니다.<br>다음 기회를 노려보세요!</p>
                        </div>
                        <button id="loseConfirmBtn" class="w-full bg-blue-500 px-6 py-2 rounded hover:bg-blue-600">
                            확인
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- 하단 네비게이션 -->
    <nav class="w-full bg-black text-white py-3 border-t border-gray-700">
        <div class="flex justify-evenly">
            <div class="text-center cursor-pointer" onclick="location.href='invite.html'">
                <i class="fas fa-user-plus text-2xl"></i>
                <p class="text-[0.4rem]">초대</p>
            </div>
            <div class="text-center cursor-pointer" onclick="checkAttendance()">
                <i class="fas fa-calendar-alt text-2xl"></i>
                <p class="text-[0.4rem]">출석부</p>
            </div>
            <div class="text-center cursor-pointer" onclick="location.href='board.html'">
                <i class="fas fa-clipboard text-2xl"></i>
                <p class="text-[0.4rem]">게시판</p>
            </div>
            <div class="text-center cursor-pointer" onclick="location.href='charge.html'">
                <i class="fas fa-coins text-2xl"></i>
                <p class="text-[0.4rem]">포인트충전</p>
            </div>
        </div>
    </nav>

    <script>
        // 전역 변수로 currentUser와 isBetting 선언
        let currentUser = null;
        let isBetting = false;

        // KBO 예측 승률 데이터
        const kboOdds = {
            'first': { success: 280, winRate: 0.28 },    // 28% 성공률 -> 배당률 3.57
            'second': { success: 180, winRate: 0.18 },   // 18% 성공률 -> 배당률 5.56
            'third': { success: 120, winRate: 0.12 },    // 12% 성공률 -> 배당률 8.33
            'homerun': { success: 50, winRate: 0.05 },   // 5% 성공률 -> 배당률 20.0
            'out': { success: 370, winRate: 0.37 }       // 37% 성공률 -> 배당률 2.70
        };

        // 배당률 계산 함수
        function calculateOdds(winRate) {
            return (1 / winRate).toFixed(2);
        }

        // 페이지 로드 시 사용자 정보와 선택값 가져오기
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const storedUser = localStorage.getItem('currentUser');
                if (storedUser) {
                    currentUser = JSON.parse(storedUser);
                    document.getElementById('userNameDisplay').textContent = `${currentUser.name}님 환영합니다!`;
                    document.getElementById('userPoints').textContent = `${currentUser.points}`;
                    document.getElementById('loginButton').style.display = 'none';
                    document.getElementById('logoutButton').style.display = 'block';
                    document.getElementById('bettingButton').addEventListener('click', handleBetting);
                    document.getElementById('bettingResultButton').addEventListener('click', showBettingResult);
                    
                    // 이전 선택값 불러오기
                    const lastGameType = localStorage.getItem('lastGameType') || 'batter';
                    const lastBettingType = localStorage.getItem('lastBettingType') || 'first';
                    const lastPoints = localStorage.getItem('lastPoints') || '100';
                    
                    // 게임 유형 선택
                    document.getElementById('gameTypeSelect').value = lastGameType;
                    const gameTypeButton = document.querySelector(`.game-type-button[onclick*="${lastGameType}"]`);
                    if (gameTypeButton) {
                        updateGameType(lastGameType, gameTypeButton);
                    }
                    
                    // 배팅 유형 선택
                    document.getElementById('bettingSelect').value = lastBettingType;
                    const bettingButton = document.querySelector(`.result-button[onclick*="${lastBettingType}"]`);
                    if (bettingButton) {
                        updateBetting(lastBettingType, bettingButton);
                    }
                    
                    // 포인트 선택
                    document.getElementById('pointSelect').value = lastPoints;
                    const pointsButton = document.querySelector(`.point-button[onclick*="${lastPoints}"]`);
                    if (pointsButton) {
                        updatePoints(lastPoints, pointsButton);
                    }
                    
                    updateExpectedPoints();
                    return;
                }
                window.location.href = '/login.html';
            } catch (error) {
                console.error('사용자 정보 로드 실패:', error);
                window.location.href = '/login.html';
            }
        });

        // 로그아웃 함수
        function logout() {
            localStorage.removeItem('currentUser');
            window.location.href = '/login.html';
        }

        // 배팅 처리 함수
        function handleBetting() {
            if (isBetting) return;

            const bettingPoints = parseInt(document.getElementById('pointSelect').value);
            const currentPoints = parseInt(document.getElementById('userPoints').textContent);
            
            if (currentPoints < bettingPoints) {
                alert('보유 포인트가 부족합니다.');
                return;
            }

            const newPoints = currentPoints - bettingPoints;
            document.getElementById('userPoints').textContent = `${newPoints} 포인트`;
            currentUser.points = newPoints;
            localStorage.setItem('currentUser', JSON.stringify(currentUser));

            document.getElementById('bettingButton').style.display = 'none';
            document.getElementById('bettingResultButton').style.display = 'block';
            isBetting = true;
        }

        // 배팅 결과 표시 함수
        async function showBettingResult() {
            if (!isBetting) return;
            
            try {
                const bettingPoints = parseInt(document.getElementById('pointSelect').value);
                const bettingType = document.getElementById('bettingSelect').value;
                const currentPoints = parseInt(document.getElementById('userPoints').textContent);
                
                const response = await fetch('/api/bet', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: currentUser.userId,
                        bettingPoints: bettingPoints,
                        matchId: 'default_match',
                        gameType: 'default_game',
                        bettingType: bettingType
                    })
                });

                if (!response.ok) {
                    throw new Error(`서버 응답 오류: ${response.status}`);
                }

                const data = await response.json();
                
                console.log('서버 응답:', data);
                console.log('배팅 타입:', bettingType);
                console.log('배팅 포인트:', bettingPoints);
                console.log('현재 포인트:', currentPoints);
                
                if (!data) {
                    throw new Error('서버에서 데이터를 받지 못했습니다.');
                }

                // 배팅 성공 여부를 랜덤하게 결정
                const winRate = kboOdds[bettingType].winRate;
                const isSuccess = Math.random() < winRate;
                console.log('배팅 성공 여부:', isSuccess);
                
                if (isSuccess) {
                    console.log('배팅 성공 처리 시작');
                    const totalParticipants = 1000;
                    const successCount = kboOdds[bettingType].success;
                    const failCount = totalParticipants - successCount;
                    const failedBettingAmount = failCount * bettingPoints;
                    const winPoints = Math.floor(failedBettingAmount / successCount);
                    
                    console.log('성공 시 계산된 포인트:', winPoints);
                    localStorage.setItem('winPoints', winPoints.toString());
                    window.location.href = '/win.html';
                } else {
                    console.log('배팅 실패 처리 시작');
                    const newPoints = currentPoints - bettingPoints;
                    console.log('실패 후 새로운 포인트:', newPoints);
                    currentUser.points = newPoints;
                    localStorage.setItem('lostPoints', bettingPoints.toString());
                    await updateServerPoints(newPoints);
                    window.location.href = '/lose.html';
                }
                
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                document.getElementById('bettingButton').style.display = 'block';
                document.getElementById('bettingResultButton').style.display = 'none';
                isBetting = false;
                updateExpectedPoints();
            } catch (error) {
                console.error('배팅 결과 처리 중 오류:', error);
                alert(`배팅 결과 처리 중 오류가 발생했습니다: ${error.message}`);
                isBetting = false;
                document.getElementById('bettingButton').style.display = 'block';
                document.getElementById('bettingResultButton').style.display = 'none';
            }
        }

        // 서버 포인트 업데이트 함수
        async function updateServerPoints(points) {
            try {
                const response = await fetch('/api/update-points', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: currentUser.userId,
                        points: points
                    })
                });

                const data = await response.json();
                if (!data.success) {
                    console.error('포인트 업데이트 실패:', data.message);
                }
            } catch (error) {
                console.error('포인트 업데이트 오류:', error);
            }
        }

        // 예상 배당금 계산 및 표시 함수
        function updateExpectedPoints() {
            const selectedPoints = parseInt(document.getElementById('pointSelect').value);
            const bettingType = document.getElementById('bettingSelect').value;
            
            const totalParticipants = 1000;
            const successCount = kboOdds[bettingType].success;
            const failCount = totalParticipants - successCount;
            const failedBettingAmount = failCount * selectedPoints;
            const expectedWinPoints = Math.floor(failedBettingAmount / successCount);
            
            document.getElementById('expectedPoints').textContent = `${expectedWinPoints} 포인트`;
            
            const afterBettingSpan = document.getElementById('afterBettingPoints');
            const currentPoints = parseInt(document.getElementById('userPoints').textContent);
            afterBettingSpan.style.display = 'inline';
            afterBettingSpan.querySelector('span').textContent = `${currentPoints - selectedPoints} 포인트`;
        }

        // 포인트 업데이트 함수 수정
        function updatePoints(points, button) {
            // 모든 포인트 버튼의 스타일 초기화
            document.querySelectorAll('.point-button').forEach(btn => {
                btn.classList.remove('ring-2', 'ring-white', 'ring-offset-2');
            });
            
            // 선택된 버튼에 스타일 적용
            button.classList.add('ring-2', 'ring-white', 'ring-offset-2');
            
            // select 요소 값 업데이트
            const select = document.getElementById('pointSelect');
            select.value = points;
            
            // 선택된 포인트 표시
            document.getElementById('selectedPoints').textContent = `선택: ${points} 포인트`;
            
            // change 이벤트 발생
            const event = new Event('change');
            select.dispatchEvent(event);
            
            // 선택값 저장
            localStorage.setItem('lastPoints', points);
        }

        // 배팅 결과 처리 후 초기화 함수 수정
        function resetBettingSelection() {
            // 배팅 버튼 상태만 초기화
            document.getElementById('bettingButton').style.display = 'block';
            document.getElementById('bettingResultButton').style.display = 'none';
            isBetting = false;
        }

        // 배팅 타입 업데이트 함수 수정
        function updateBetting(type, button) {
            // 모든 버튼의 스타일 초기화
            document.querySelectorAll('.result-button').forEach(btn => {
                btn.classList.remove('ring-2', 'ring-white', 'ring-offset-2');
            });
            
            // 선택된 버튼에 스타일 적용
            button.classList.add('ring-2', 'ring-white', 'ring-offset-2');
            
            // select 요소 값 업데이트
            const select = document.getElementById('bettingSelect');
            select.value = type;
            
            // 선택된 배팅 유형 표시
            const bettingText = {
                'first': '1루',
                'second': '2루',
                'third': '3루',
                'homerun': '홈런',
                'out': '아웃'
            };
            document.getElementById('selectedBetting').textContent = `선택: ${bettingText[type]}`;
            
            // change 이벤트 발생
            const event = new Event('change');
            select.dispatchEvent(event);
            
            // 선택값 저장
            localStorage.setItem('lastBettingType', type);
        }

        // 게임 유형 업데이트 함수 수정
        function updateGameType(type, button) {
            // 모든 게임 유형 버튼의 스타일 초기화
            document.querySelectorAll('.game-type-button').forEach(btn => {
                btn.classList.remove('ring-2', 'ring-white', 'ring-offset-2');
            });
            
            // 선택된 버튼에 스타일 적용
            button.classList.add('ring-2', 'ring-white', 'ring-offset-2');
            
            // select 요소 값 업데이트
            const select = document.getElementById('gameTypeSelect');
            select.value = type;
            
            // 선택된 게임 유형 표시
            const typeText = {
                'batter': '타자',
                'defense': '수비',
                'pitcher': '투수'
            };
            document.getElementById('selectedGameType').textContent = `선택: ${typeText[type]}`;
            
            // 선택값 저장
            localStorage.setItem('lastGameType', type);
        }

        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', function() {
            resetBettingSelection();
            updateCurrentDate();
        });

        // 현재 날짜 표시 함수
        function updateCurrentDate() {
            const now = new Date();
            const options = { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric', 
                weekday: 'long' 
            };
            const dateString = now.toLocaleDateString('ko-KR', options);
            document.getElementById('currentDate').textContent = dateString;
        }

        // 출석체크 함수
        async function checkAttendance() {
            if (!currentUser) {
                alert('로그인이 필요한 서비스입니다.');
                window.location.href = '/login.html';
                return;
            }
            window.location.href = '/attendance.html';
        }
    </script>

